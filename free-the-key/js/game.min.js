(function(){this.onReady=function(){core.GenericGame.prototype.bootstrap.call(this,game_shell.BootStrap)},this.preloadComplete=function(){game_shell.game.DataBuilder.execute(),this.game.gameScreens.call(game_shell.screenMgr),this.screenMgr.showScreen(core.settings.FIRST_SCREEN)},this.title={},this.menu={},this.game={},this.version="1.1.5";}).call(game_shell),core.display.Stage.prototype.resize=function(settings){var scale,workingH,workingW,pixelW,pixelH,isPortrait=game_shell.viewport.isPortrait,resolution=this.renderer.resolution,dpr=window.devicePixelRatio||1,configHeight=settings.height,configWidth=settings.width,aspectRatio=settings.pixelWidth/settings.pixelHeight;isPortrait?(scale=configWidth*resolution/settings.pixelWidth,workingW=configWidth,workingH=configWidth/aspectRatio):(scale=configHeight*resolution/settings.pixelHeight,workingW=configHeight*aspectRatio,workingH=configHeight),pixelW=workingW*dpr,pixelH=workingH*dpr,this.renderer.resize(pixelW,pixelH),this.content.x=.5*pixelW,this.content.y=.5*pixelH,this.content.scale.set(dpr);var canvasCSSWidth=workingW/scale*resolution,canvasCSSHeight=workingH/scale*resolution,canvasElement=this.renderer.view;canvasElement.style.width=canvasCSSWidth+"px",canvasElement.style.height=canvasCSSHeight+"px",this.draw()},game_shell.BootStrap=function(){core.load.BootStrap.call(this),this.barColor=15366678},game_shell.BootStrap.prototype=Object.create(core.load.BootStrap.prototype),game_shell.BootStrap.prototype.defineBundle=function(){var jsonFolder=(core.settings.IMG_DIR,core.settings.JSON_DIR);this.addJson({src:jsonFolder+"maps.json",id:"maps"})},core.load.BootStrap.prototype.createLoadBar=function(){var w=10,h=20;this.bar=new core.display.Quad(w,h,this.barColor),this.bar.x=this.stageW*-.5,this.bar.y=.5*this.stageH+h*-.5,this.stage.addChild(this.bar)},game_shell.game.User=function(){this._currentLevel=1,this.gameData=null,this.recordsList=null,this.recordsMap=null},game_shell.game.User.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.storage=new core.utils.Save("free-the-key"),this.createUserRecords(),this.currentLevel=1},Object.defineProperties(game_shell.game.User.prototype,{currentLevel:{get:function(){return this._currentLevel},set:function(value){this._currentLevel=value,this.unlockLevel(value)}},isLastLevel:{get:function(){return this._currentLevel===this.recordsList.length}}}),game_shell.game.User.prototype.cheatUnlock=function(){var i,record,n=this.recordsList.length;for(i=0;i<n;i++)record=this.recordsList[i],record.unlocked=!0},game_shell.game.User.prototype.levelComplete=function(userRecord){console.log("user > levelComplete",userRecord),this.currentLevel++,this.storage.save(this.generateSaveData())},game_shell.game.User.prototype.createUserRecords=function(){this.recordsList=[],this.recordsMap={};var mapId,mapData,record,maps=this.gameData.maps,savedResults=this.fetchSavedResults();for(mapId in maps){if(mapData=maps[mapId],record=new game_shell.game.UserRecord,record.init({mapId:mapId}),savedResults){var result=this.getByMapId(mapId,savedResults);record.restore(result)}this.recordsList.push(record),this.recordsMap[mapId]=record}return this.recordsList},game_shell.game.User.prototype.fetchSavedResults=function(){return this.storage.restore()},game_shell.game.User.prototype.getByMapId=function(mapId,list){var i,item,result=null,n=list.length;for(i=0;i<n;i++)if(item=list[i],item.mapId===mapId){result=item;break}return result},game_shell.game.User.prototype.generateSaveData=function(){return this.recordsList.map(function(record){return{bestMoves:record.bestMoves,unlocked:record.unlocked,mapId:record.mapId}})},game_shell.game.User.prototype.unlockLevel=function(levelIndex){var record=this.getUserRecord(levelIndex);return record.unlocked=!0,record},game_shell.game.User.prototype.getUserRecord=function(levelIndex){"undefined"==typeof levelIndex&&(levelIndex=this._currentLevel);var mapData=this.getMap(levelIndex);return this.recordsMap[mapData.name]},game_shell.game.User.prototype.setUserRecord=function(userRecord){var listIndex=this.recordsList.indexOf(userRecord);return this._currentLevel=listIndex+1,this._currentLevel},game_shell.game.User.prototype.getMap=function(levelIndex){return levelIndex||(levelIndex=this.currentLevel),this.gameData.getMap(levelIndex)},game_shell.game.GameData=function(){this.maps=null},game_shell.game.GameData.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s])},game_shell.game.GameData.prototype.getMap=function(index){var id="level_"+index;return this.maps[id]},game_shell.game.DataBuilder={execute:function(){game_shell.gameData=this.createGameData(),game_shell.user=this.createUser(game_shell.gameData)},createGameData:function(){var gameData=new game_shell.game.GameData;return gameData.init({maps:game_shell.json.maps}),gameData},createUser:function(gameData){var user=new game_shell.game.User;return user.init({gameData:gameData}),game_shell.config.CHEAT_UNLOCK&&user.cheatUnlock(),user}},game_shell.game.UserRecord=function(){this.mapId=null,this.moves=0,this.bestMoves=0,this.unlocked=!1},game_shell.game.UserRecord.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s])},game_shell.game.UserRecord.prototype.move=function(){return++this.moves},game_shell.game.UserRecord.prototype.reset=function(){this.moves=0},game_shell.game.UserRecord.prototype.restore=function(source){return source?(this.bestMoves=source.bestMoves,void(this.unlocked=source.unlocked)):void console.log("null restore for ",this.mapId)},game_shell.game.UserRecord.prototype.complete=function(){(0===this.bestMoves||this.bestMoves>0&&this.moves<this.bestMoves)&&(this.bestMoves=this.moves)},game_shell.game.gameScreens=function(){this.createScreen=function(event){var screen,screenId="string"==typeof event?event:event.screenId;switch(screenId){case"load":screen=new core.screens.LoadScreen(event);break;case"title":screen=new game_shell.screens.TitleScreen(event);break;case"menu":screen=new game_shell.screens.MenuScreen(event);break;case"game":screen=new game_shell.screens.GameScreen(event)}return screen},this.getManifestPath=function(screenId){var dir=core.settings.JSON_DIR+"manifests/",file=null;switch(screenId){case"load":file=null;break;default:file=dir+"asset_manifest.json"}return file}},game_shell.screens.TitleScreen=function(config){core.screens.ScreenBase.call(this,config)},game_shell.screens.TitleScreen.prototype=Object.create(core.screens.ScreenBase.prototype),game_shell.screens.TitleScreen.prototype.constructor=game_shell.screens.TitleScreen,game_shell.screens.TitleScreen.prototype.run=function(){this.scene=this.createScene(game_shell.title.TitleScene);var self=this;this.scene.bus.on("navigate",function(){self.newScreen("menu")})},game_shell.title.TitleScene=function(){this.resolution=1,this.root=null,this.timeout=null,this.updateList=null,this.screenW=0,this.screenH=0},game_shell.title.TitleScene.prototype=Object.create(core.utils.EventDispatcher.prototype),game_shell.title.TitleScene.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.build();var bus=this.bus;this.bg.on("release",function(){bus.emit({type:"navigate"})}),this.fadeIn(this.title,500),this.snd.playWithDelay("intro",1e3,.5)},game_shell.title.TitleScene.prototype.fadeIn=function(sprite,delay){return new TWEEN.Tween(sprite).to({alpha:1},1e3).delay(delay).start()},game_shell.title.TitleScene.prototype.fadeOut=function(sprite,delay){return new TWEEN.Tween(sprite).to({alpha:0},1e3).delay(delay).start()},game_shell.title.TitleScene.prototype.build=function(){var builder=new game_shell.title.TitleBuilder;return builder.init({scene:this,screenW:this.screenW,screenH:this.screenH,resolution:this.resolution}),builder},game_shell.title.TitleScene.prototype.update=function(delta){},game_shell.title.TitleBuilder=function(){core.screens.SceneBuilder.call(this)},game_shell.title.TitleBuilder.prototype.init=function(config){core.screens.SceneBuilder.prototype.init.call(this,config),this.scene.bus=new core.utils.EventDispatcher,this.scene.bg=this.createBg(this.scene),this.scene.title=this.createTitle(this.scene),this.scene.dustMotes=this.createDustMotes(this.scene),this.scene.version=this.createVersion(this.scene)},game_shell.title.TitleBuilder.prototype.createDustMotes=function(scene){var dustMotes=new game_shell.title.DustMotes;return dustMotes.init({screenW:scene.screenW,screenH:scene.screenH}),scene.updateList.add(dustMotes),scene.root.addChild(dustMotes.root),dustMotes},game_shell.title.TitleBuilder.prototype.createVersion=function(scene){var version=game_shell.version;console.log(version);var txtVersion="v"+version,text=new PIXI.Text(txtVersion,{font:"20px Arial",fill:16777215,align:"right"});return text.x=.5*scene.bg.width,text.y=.5*scene.screenH,text.anchor.set(1),text.scale.set(.5),scene.root.addChild(text),text},game_shell.title.TitleBuilder.prototype.createBg=function(scene){var bg=new core.display.Button(PIXI.utils.TextureCache["title_screen_bg.png"]);return bg.downScale=1,scene.root.addChild(bg),bg},game_shell.title.TitleBuilder.prototype.createTitle=function(scene,tint){var sprite=new PIXI.Sprite(PIXI.utils.TextureCache["game_title.png"]);return sprite.anchor.set(.5),sprite.alpha=0,tint&&(sprite.tint=tint),scene.root.addChild(sprite),sprite},game_shell.title.DustMotes=function(){this.root=null,this.particles=null},game_shell.title.DustMotes.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.root=new PIXI.Container,this.particles=this.createParticles(this)},game_shell.title.DustMotes.prototype.createParticles=function(owner){var particles=[],spacing=100,y=owner.screenH*-.5;y+=spacing/2;for(var bottom=.5*owner.screenH;y<bottom;)owner.addRow(y,spacing,particles,owner),y+=spacing;return particles},game_shell.title.DustMotes.prototype.addRow=function(y,spacing,particles,owner){for(var right=.5*owner.screenW,x=owner.screenW*-.5+spacing/2;x<right;){var particle=owner.createParticle(x,y,owner);particles.push(particle),x+=spacing}},game_shell.title.DustMotes.prototype.createParticle=function(x,y,owner){var particle=new game_shell.title.DustParticle;return particle.init({x:x,y:y}),owner.root.addChild(particle.root),particle},game_shell.title.DustMotes.prototype.update=function(delta){var i,p,n=this.particles.length;for(i=0;i<n;i++)p=this.particles[i],p.update(delta)},game_shell.title.DustParticle=function(){this.sprite=null},game_shell.title.DustParticle.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.root=new PIXI.Container,this.root.x=config.x,this.root.y=config.y,this.sprite=this.createSprite(this),this.position=this.createPosition(this),this.fade=this.createFade(this),this.scale=this.createScale(this)},game_shell.title.DustParticle.prototype.createScale=function(dust){var scale=this.createFade(dust);return scale.scale=!0,scale},game_shell.title.DustParticle.prototype.createFade=function(dust){var fade=new game_shell.title.DustFade;return fade.init({sprite:dust.sprite}),fade},game_shell.title.DustParticle.prototype.createPosition=function(dust){var position=new game_shell.title.DustPosition;return position.init({dust:dust}),position},game_shell.title.DustParticle.prototype.createSprite=function(owner){var sprite=new PIXI.Sprite(PIXI.utils.TextureCache["dust.png"]);return sprite.anchor.set(.5),owner.root.addChild(sprite),sprite},game_shell.title.DustParticle.prototype.update=function(delta){this.position.update(delta),this.fade.update(delta),this.scale.update(delta)},game_shell.title.DustPosition=function(){this.dust=null,this.range=20,this.osc1=null,this.osc2=null},game_shell.title.DustPosition.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.osc1=this.createOscillator(),this.osc2=this.createOscillator(),this.update(500)},game_shell.title.DustPosition.prototype.update=function(delta){var slowDown=.3;this.osc1.update(delta*slowDown),this.osc2.update(delta*slowDown),this.dust.sprite.position.x=this.osc1.x*this.range+this.osc2.x*this.range,this.dust.sprite.position.y=this.osc1.y*this.range+this.osc2.y*this.range},game_shell.title.DustPosition.prototype.createOscillator=function(){var o=new core.motion.Oscillator;return o.init({time:Math.random()*Math.PI*300}),o.randomise(),o},game_shell.title.DustFade=function(){this.sprite=null,this.scale=!1},game_shell.title.DustFade.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.osc=this.createOscillator(),this.update(500)},game_shell.title.DustFade.prototype.createOscillator=function(){var o=new core.motion.Oscillator;return o.init({time:Math.random()*Math.PI*300}),o.randomise(),o},game_shell.title.DustFade.prototype.update=function(delta){var slow=.5;this.osc.update(delta*slow);var alpha=this.osc.x>0?this.osc.x:-this.osc.x;this.scale?this.sprite.scale.set(alpha):this.sprite.alpha=alpha},game_shell.screens.MenuScreen=function(config){core.screens.ScreenBase.call(this,config)},game_shell.screens.MenuScreen.prototype=Object.create(core.screens.ScreenBase.prototype),game_shell.screens.MenuScreen.prototype.constructor=game_shell.screens.MenuScreen,game_shell.screens.MenuScreen.prototype.run=function(){this.scene=this.createScene(game_shell.menu.MenuScene),this.selectLevel=this._selectLevel.bind(this),this.scene.bus.on("select",this.selectLevel),this.eventQueue.emit({type:"game_event",msg:"enter_menu"})},game_shell.screens.MenuScreen.prototype._selectLevel=function(event){this.scene.stopSfx();var userRecord=event.userRecord;game_shell.user.setUserRecord(userRecord),this.eventQueue.emit({type:"game_event",msg:"exit_menu"}),this.newScreen("game")},game_shell.screens.MenuScreen.prototype.getSceneConfig=function(){var config=core.screens.ScreenBase.prototype.getSceneConfig.call(this);return config.user=game_shell.user,config.showMoreGames=!!game_shell.config.MORE_GAMES,config},game_shell.menu.MenuScene=function(){this.resolution=1,this.root=null,this.timeout=null,this.updateList=null,this.screenW=0,this.screenH=0,this.sfx="gong2"},game_shell.menu.MenuScene.prototype=Object.create(core.utils.EventDispatcher.prototype),game_shell.menu.MenuScene.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.dragEnd=this._dragEnd.bind(this),this.changePage=this._changePage.bind(this),this.build(),this.snd.playWithDelay(this.sfx,1e3),this.bus.on("drag_end",this.dragEnd),this.bus.on("page",this.changePage),this.user.currentLevel>20&&(this.scrollDrag.jumpToPage(2),this.pagingIcons.setPage(2))},game_shell.menu.MenuScene.prototype._changePage=function(event){event.direction>0?this.goToPage2():event.direction<0&&this.goToPage1()},game_shell.menu.MenuScene.prototype.goToPage2=function(){var dist=this.scrollDrag.tweenMin();this.pagingIcons.setPage(2),dist>0&&this.slideSfx()},game_shell.menu.MenuScene.prototype.goToPage1=function(){var dist=this.scrollDrag.tweenMax();this.pagingIcons.setPage(1),dist>0&&this.slideSfx()},game_shell.menu.MenuScene.prototype.slideSfx=function(){this.snd.play("page_slide",.5)},game_shell.menu.MenuScene.prototype._dragEnd=function(event){var sign=this.motionTracker.sign;if(sign<0)this.goToPage2();else if(sign>0)this.goToPage1(1);else{var sign=this.scrollDrag.toNearest();sign>0?this.pagingIcons.setPage(1):this.pagingIcons.setPage(2)}},game_shell.menu.MenuScene.prototype.stopSfx=function(){this.snd.isPlaying(this.sfx)&&this.snd.fadeOut(this.sfx)},game_shell.menu.MenuScene.prototype.build=function(){var builder=new game_shell.menu.MenuBuilder;return builder.init({scene:this}),builder},game_shell.menu.MenuBuilder=function(){core.screens.SceneBuilder.call(this)},game_shell.menu.MenuBuilder.prototype.init=function(config){core.screens.SceneBuilder.prototype.init.call(this,config),this.scene.touchArea=this.createTouchArea(this.scene),this.scene.scrolling=this.scene.root.addChild(new PIXI.Container),this.createBackgrounds(this.scene),this.scene.menuItems=this.createMenuItems(this.scene),this.scene.scrollDrag=this.createScrollDrag(this.scene),this.scene.motionTracker=this.createMotionTracker(this.scene),this.scene.pagingIcons=this.createPagingIcons(this.scene),this.scene.showMoreGames&&(this.scene.btnMoreGames=this.createBtnMoreGames(this.scene))},game_shell.menu.MenuBuilder.prototype.createPagingIcons=function(scene){var pagingIcons=new game_shell.menu.PagingIcons;return pagingIcons.init({bus:scene.bus}),pagingIcons.root.y=175,scene.root.addChild(pagingIcons.root),pagingIcons},game_shell.menu.MenuBuilder.prototype.createBtnMoreGames=function(scene){var btnMoreGames=new core.display.Button(PIXI.utils.TextureCache["more_games_button.png"]);return btnMoreGames.y=scene.pagingIcons.root.y,scene.pagingIcons.root.x=-50,btnMoreGames.x=75,btnMoreGames.on("release",function(){game_shell.eventQueue.emit({type:"game_event",msg:"more_games"})}),scene.root.addChild(btnMoreGames),btnMoreGames},game_shell.menu.MenuBuilder.prototype.createMotionTracker=function(scene){var motionTracker=new game_shell.menu.MotionTracker;return motionTracker.init({target:scene.scrollDrag.scrolling}),scene.updateList.add(motionTracker),motionTracker},game_shell.menu.MenuBuilder.prototype.createMenuItems=function(scene){var items=[],l1=-120,l2=-80,y1=-130,y2=y1/2,y3=0,y4=-y2,y5=-y1;this.createMenuRow(l1,y1,items,scene),this.createMenuRow(l2,y2,items,scene),this.createMenuRow(l1,y3,items,scene),this.createMenuRow(l2,y4,items,scene),this.createMenuRow(l1,y5,items,scene);var pageW=scene.screenW;return l1+=pageW,l2+=pageW,this.createMenuRow(l1,y1,items,scene),this.createMenuRow(l2,y2,items,scene),this.createMenuRow(l1,y3,items,scene),this.createMenuRow(l2,y4,items,scene),this.createMenuRow(l1,y5,items,scene),items},game_shell.menu.MenuBuilder.prototype.createScrollDrag=function(scene){var scrollDrag=new game_shell.menu.ScrollDrag;return scrollDrag.init({minX:-scene.screenW,bus:scene.bus,root:scene.root,background:scene.touchArea,scrolling:scene.scrolling}),scrollDrag},game_shell.menu.MenuBuilder.prototype.createMenuRow=function(x,y,items,scene){for(var itemsPerRow=4,gap=67;itemsPerRow>0;)itemsPerRow--,items.push(this.createMenuItem(x,y,items.length,scene)),x+=gap},game_shell.menu.MenuBuilder.prototype.createMenuItem=function(x,y,index,scene){var menuItem=new game_shell.menu.MenuItem,userRecord=scene.user.getUserRecord(index+1);return menuItem.init({bus:scene.bus,resolution:scene.resolution,userRecord:userRecord,index:index}),menuItem.root.position.set(x,y),scene.scrolling.addChild(menuItem.root),menuItem},game_shell.menu.MenuBuilder.prototype.createBackgrounds=function(scene){var bg=new PIXI.Sprite(PIXI.utils.TextureCache["menu_bg_left.png"]);bg.anchor.set(.5),scene.scrolling.addChild(bg),bg=new PIXI.Sprite(PIXI.utils.TextureCache["menu_bg_right.png"]),bg.anchor.set(.5),bg.x=scene.screenW,scene.scrolling.addChild(bg)},game_shell.menu.MenuBuilder.prototype.createTouchArea=function(scene){var bg=new PIXI.Sprite(PIXI.utils.TextureCache["menu_bg_left.png"]);return bg.anchor.set(.5),bg.alpha=0,scene.root.addChild(bg),bg},game_shell.menu.MenuItem=function(){this.userRecord=null},game_shell.menu.MenuItem.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.root=new PIXI.Container,this.scaler=new PIXI.Container,this.root.addChild(this.scaler),this.roundel=this.createRoundel(this),this.unlocked=this.userRecord.unlocked,this.unlocked&&(this.label=this.createLabel(this),this.userRecord.bestMoves>0&&(this.scorePanel=this.createScorePanel(this),this.bestScore=this.createBestScore(this))),this.addListeners(this)},game_shell.menu.MenuItem.prototype.createLabel=function(menuItem){const msg=(menuItem.index+1).toString(),bitmapText=new PIXI.extras.BitmapText(msg,{font:{name:"tempus_sans",size:24}});return bitmapText.pivot.x=.5*bitmapText.width,bitmapText.pivot.y=.5*bitmapText.height,bitmapText.y=-6,menuItem.scaler.addChild(bitmapText),bitmapText},game_shell.menu.MenuItem.prototype.createScorePanel=function(menuItem){var scorePanel=new PIXI.Sprite(PIXI.utils.TextureCache["score_panel.png"]);return scorePanel.anchor.set(1),scorePanel.y=31,scorePanel.x=20,menuItem.root.addChild(scorePanel),scorePanel},game_shell.menu.MenuItem.prototype.createBestScore=function(menuItem){var score=menuItem.userRecord.bestMoves.toString(),fill="#ca730e",bestScore=new PIXI.Text(score,{font:"24px Arial",fill:fill});return bestScore.anchor.set(1),bestScore.scale.set(.5),bestScore.x=17,bestScore.y=30,menuItem.root.addChild(bestScore),bestScore},Object.defineProperties(game_shell.menu.MenuItem.prototype,{unlocked:{get:function(){return this.userRecord.unlocked},set:function(value){this.roundel.enabled=value,value||(this.roundel.texture=PIXI.utils.TextureCache["locked.png"])}}}),game_shell.menu.MenuItem.prototype.addListeners=function(menuItem){var bus=menuItem.bus,userRecord=menuItem.userRecord;menuItem.roundel.on("release",function(){bus.emit({type:"select",userRecord:userRecord})})},game_shell.menu.MenuItem.prototype.createRoundel=function(menuItem){var txId="menu_item.png",roundel=new core.display.Button(PIXI.utils.TextureCache[txId]);return roundel.scale=menuItem.scaler.scale,menuItem.scaler.addChild(roundel),roundel},game_shell.menu.ScrollDrag=function(){this.background=null,this.scrolling=null,this.root=null,this.maxX=0,this.minX=-100,this.offset=new PIXI.Point,this.position=new PIXI.Point,this._isPress=!1,this.selectThreshold=10,this.eventSelect={type:"select",x:0},this.eventDrag={type:"drag",amount:0},this.eventDragEnd={type:"drag_end",amount:0},this.snapTween=null},game_shell.menu.ScrollDrag.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.bindMethods(this),this.snapTween=new TWEEN.Tween(this.scrolling.position),this.addListeners(this,this.background),this.startX=this.maxX=this.scrolling.x,this.enable(!0)},game_shell.menu.ScrollDrag.prototype.enable=function(bool){this.background.interactive=bool,this.background.buttonMode=bool},game_shell.menu.ScrollDrag.prototype.reset=function(scrollLimit){this.scrolling.x=0,this.startX=this.maxX=this.scrolling.x,this.minX=scrollLimit},game_shell.menu.ScrollDrag.prototype.bindMethods=function(owner){owner.touchstart=owner._touchstart.bind(owner),owner.touchmove=owner._touchmove.bind(owner),owner.touchend=owner._touchend.bind(owner)},game_shell.menu.ScrollDrag.prototype.addListeners=function(owner,target){target.on("mousedown",owner.touchstart),target.on("touchstart",owner.touchstart),target.on("mousemove",owner.touchmove),target.on("touchmove",owner.touchmove),target.on("mouseup",owner.touchend),target.on("touchend",owner.touchend),target.on("mouseupoutside",owner.touchend),target.on("touchendoutside",owner.touchend)},game_shell.menu.ScrollDrag.prototype._touchstart=function(event){this.snapTween.stop(),event.data.getLocalPosition(this.root,this.offset),this.startX=this.scrolling.x,this.scrollWithEmit(this.startX),this._isPress=!0},game_shell.menu.ScrollDrag.prototype._touchmove=function(event){if(this._isPress){event.data.getLocalPosition(this.root,this.position);var distY=this.position.x-this.offset.x;this.scrollWithEmit(this.startX+distY)}},game_shell.menu.ScrollDrag.prototype._touchend=function(event){this._isPress,this._isPress=!1,this.bus.emit(this.eventDragEnd)},game_shell.menu.ScrollDrag.prototype.updateScroll=function(amount){var newY=this.minX+(this.maxX-this.minX)*amount;this.scrollTo(newY)},game_shell.menu.ScrollDrag.prototype.scrollWithEmit=function(targetX){this.scrollTo(targetX)},game_shell.menu.ScrollDrag.prototype.scrollTo=function(targetX){return targetX>this.maxX?targetX=this.maxX:targetX<this.minX&&(targetX=this.minX),this.scrolling.x=targetX,targetX},game_shell.menu.ScrollDrag.prototype.jumpToPage=function(page){2===page?this.scrolling.x=this.minX:1===page&&(this.scrolling.x=this.maxX)},game_shell.menu.ScrollDrag.prototype.tweenMin=function(){this.snapTween.stop();var time=this.getTweenTime(this.minX);return this.snapTween.to({x:this.minX},time).start(),time},game_shell.menu.ScrollDrag.prototype.getTweenTime=function(targetX){var distX=this.scrolling.x-targetX;return distX<0&&(distX=-distX),distX},game_shell.menu.ScrollDrag.prototype.toNearest=function(){var x=this.scrolling.x,difMin=x-this.minX,difMax=this.maxX-x,sign=difMax<difMin?1:-1;return 1===sign?this.tweenMax():this.tweenMin(),sign},game_shell.menu.ScrollDrag.prototype.tweenMax=function(){this.snapTween.stop();var time=this.getTweenTime(this.maxX);return this.snapTween.to({x:this.maxX},time).start(),time},game_shell.menu.MotionTracker=function(){this.target=null,this.positions=[0,0,0,0,0],this.refreshInterval=30,this.time=0},game_shell.menu.MotionTracker.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s])},Object.defineProperties(game_shell.menu.MotionTracker.prototype,{sign:{get:function(){var sum=this.sum;return sum>0?1:sum<0?-1:0}},sum:{get:function(){return this.getSum()}}}),game_shell.menu.MotionTracker.prototype.getSum=function(){var i,current,previous,sum=0,n=this.positions.length,offset=9999;for(i=n-1;i>0;i--)current=this.positions[i]+offset,previous=this.positions[i-1]+offset,sum+=current-previous;return sum},game_shell.menu.MotionTracker.prototype.refresh=function(){for(var n=this.positions.length-1,index=0;index<n;)this.positions[index]=this.positions[index+1],index++;this.positions[n]=this.target.x},game_shell.menu.MotionTracker.prototype.update=function(delta){this.time+=delta,this.time>this.refreshInterval&&(this.time-=this.refreshInterval,this.refresh())},game_shell.menu.PagingIcons=function(){this.root=null,this.bus=null,this.eventPage={type:"page",direction:0}},game_shell.menu.PagingIcons.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.txSelected=PIXI.utils.TextureCache["page_on.png"],this.txDeselected=PIXI.utils.TextureCache["page_off.png"],this.root=new PIXI.Container,this.bg=this.createBg(this),this.page1=this.createPageIcon(this,-10),this.page2=this.createPageIcon(this,10),this.buttonLeft=this.createButton(this,-30),this.buttonRight=this.createButton(this,30),this.setPage(1)},game_shell.menu.PagingIcons.prototype.createButton=function(owner,x){var button=new core.display.Button(PIXI.utils.TextureCache["menu_item.png"]);owner.root.addChild(button),button.x=x,button.alpha=0;var direction=x>0?1:-1;return button.on("release",function(){owner.eventPage.direction=direction,owner.bus.emit(owner.eventPage)}),button},game_shell.menu.PagingIcons.prototype.setPage=function(index){switch(index){case 1:this.page1.texture=this.txSelected,this.page2.texture=this.txDeselected;break;case 2:this.page1.texture=this.txDeselected,this.page2.texture=this.txSelected}},game_shell.menu.PagingIcons.prototype.createPageIcon=function(owner,x){var sprite=new PIXI.Sprite(PIXI.utils.TextureCache[owner.txDeselected]);return sprite.anchor.set(.5),sprite.x=x,owner.root.addChild(sprite),sprite},game_shell.menu.PagingIcons.prototype.createBg=function(owner){var sprite=new PIXI.Sprite(PIXI.utils.TextureCache["paging.png"]);return sprite.anchor.set(.5),owner.root.addChild(sprite),sprite},game_shell.screens.GameScreen=function(config){core.screens.ScreenBase.call(this,config),this.eventGameStart={type:"game_event",msg:"game_start"},this.eventLevelStart={type:"game_event",msg:"level_start"},this.eventGameOver={type:"game_event",msg:"game_over"},this.eventLevelComplete={type:"game_event",msg:"level_complete"}},game_shell.screens.GameScreen.prototype=Object.create(core.screens.ScreenBase.prototype),game_shell.screens.GameScreen.prototype.constructor=game_shell.screens.GameScreen,game_shell.screens.GameScreen.prototype.run=function(){this.nextLevel=this._nextLevel.bind(this),this.goToMenu=this._goToMenu.bind(this),this.transitionToTitle=this._transitionToTitle.bind(this),this.goToTitle=this._goToTitle.bind(this),this.eventQueue.emit(this.eventGameStart),this.createLevel()},game_shell.screens.GameScreen.prototype._goToTitle=function(){this.disposeScene(),this.eventQueue.emit(this.eventGameOver),this.newScreen("title")},game_shell.screens.GameScreen.prototype._goToMenu=function(){this.disposeScene(),this.eventQueue.emit(this.eventGameOver),this.newScreen("menu")},game_shell.screens.GameScreen.prototype.createLevel=function(){this.scene=this.createScene(game_shell.game.GameScene),this.scene.bus.on("next_level",this.nextLevel),this.scene.bus.on("home",this.goToMenu),this.scene.bus.on("dismiss_end",this.transitionToTitle),this.eventQueue.emit(this.eventLevelStart)},game_shell.screens.GameScreen.prototype._transitionToTitle=function(){var title=new PIXI.Sprite(PIXI.utils.TextureCache["title_screen_bg.png"]);title.anchor.set(.5),title.alpha=0,this.scene.root.addChild(title),new TWEEN.Tween(title).to({alpha:1},1e3).onComplete(this.goToTitle).start()},game_shell.screens.GameScreen.prototype.disposeScene=function(){this.scene.dispose(),this.scene=null},game_shell.screens.GameScreen.prototype._nextLevel=function(){game_shell.user.isLastLevel?this.scene.gameComplete():(this.eventQueue.emit(this.eventLevelComplete),this.disposeScene(),this.createLevel())},game_shell.screens.GameScreen.prototype.getSceneConfig=function(){var config=core.screens.ScreenBase.prototype.getSceneConfig.call(this);return console.log("Level ",game_shell.user.currentLevel),config.map=game_shell.user.getMap(),config.user=game_shell.user,config.userRecord=game_shell.user.getUserRecord(),config},game_shell.game.Rotation={HORIZONTAL:0,VERTICAL:1},game_shell.game.ExitTransition=function(){this.blocks=null,this.particles=null,this.bus=null,this.timeout=null},game_shell.game.ExitTransition.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s])},game_shell.game.ExitTransition.prototype.activate=function(){var self=this;this.snd.play("gong");var fireTime=500,blockTime=1e3,nextTime=2500;this.timeout.delay(function(){self.particles.emit(.5),self.snd.play("fire")},fireTime),this.timeout.delay(function(){self.moveBlocks()},blockTime),this.timeout.delay(function(){self.bus.emit({type:"next_level"})},nextTime)},game_shell.game.ExitTransition.prototype.moveBlocks=function(){var i,block,n=this.blocks.length;for(i=0;i<n;i++)block=this.blocks[i],block.transitionOut()},game_shell.game.EndTransition=function(){this.root=null,this.stars=null,this.timeout=null},game_shell.game.EndTransition.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.showText=this._showText.bind(this),this.tap=this._tap.bind(this),this.root=new PIXI.Container,this.root.visible=!1,this.stars=this.createStarStrips(this),this.blackout=this.createBlackout(this),this.gameOverText=this.createGameOverText(this)},game_shell.game.EndTransition.prototype._tap=function(){this.bus.emit({type:"dismiss_end"})},game_shell.game.EndTransition.prototype.createBlackout=function(owner){var sprite=new PIXI.Sprite(PIXI.utils.TextureCache["black_strip.png"]);sprite.anchor.set(.5),sprite.width=owner.screenW,sprite.height=owner.screenH,sprite.on("touchend",owner.tap),sprite.on("mouseup",owner.tap),sprite.interactive=!0,sprite.buttonMode=!0;var holder=new PIXI.Container;return holder.alpha=0,owner.root.addChild(holder),holder.addChild(sprite),holder},game_shell.game.EndTransition.prototype._showText=function(){new TWEEN.Tween(this.gameOverText).to({alpha:1},1e3).start(),new TWEEN.Tween(this.blackout).to({alpha:.8},500).delay(500).start();this.snd.play("game_over")},game_shell.game.EndTransition.prototype.activate=function(){this.root.visible=!0;var i,star,n=this.stars.length;for(i=0;i<n;i++)star=this.stars[i],star.activate(i);this.timeout.delay(this.showText,4e3)},game_shell.game.EndTransition.prototype.createGameOverText=function(owner){var gameOverText=new PIXI.Sprite(PIXI.utils.TextureCache["game_over.png"]);return gameOverText.anchor.set(.5),
gameOverText.alpha=0,owner.root.addChild(gameOverText),gameOverText},game_shell.game.EndTransition.prototype.createStarStrips=function(owner){var stars=[],sfx=new core.utils.Sequence(["star1","star2","star3"],(!1)),star=this.createStarStrip(owner,0,0,sfx);stars[0]=star;for(var buffer=1,w=star.strip.width-buffer,numStars=Math.ceil(this.screenW/w),tints=new core.utils.Sequence([16025647,9510144,9658689,12333840,10180366,13994787,10322545]),x=w;stars.length<numStars;)stars[stars.length]=this.createStarStrip(owner,x,tints.next(),sfx),stars[stars.length]=this.createStarStrip(owner,-x,tints.next(),sfx),x+=w;return core.utils.Randomise.randomise(stars),stars},game_shell.game.EndTransition.prototype.createStarStrip=function(owner,x,colour,sfx){var star=new game_shell.game.StarStrip;return star.init({snd:owner.snd,sfx:sfx,timeout:owner.timeout,colour:colour}),owner.root.addChild(star.root),star.root.x=x,star},game_shell.game.StarStrip=function(){this.star=null,this.strip=null,this.root=null,this.stageH=1136,this.size=60,this.colours=[16025647,9510144,9658689,12333840,10180366,13994787,10322545]},game_shell.game.StarStrip.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.playSfx=this._playSfx.bind(this),this.root=new PIXI.Container,this.root.y=this.stageH*-.6,this.strip=this.createStrip(this.root,this.stageH),this.star=this.createStar(this.root),this.colour||(this.colour=this.chooseColour(this.strip,this.colours)),this.strip.tint=this.colour},game_shell.game.StarStrip.prototype._playSfx=function(){var sfx=this.sfx.next();this.snd.play(sfx,.4)},game_shell.game.StarStrip.prototype.activate=function(index){var delay=300*index,targetY=.6*this.stageH,tw=new TWEEN.Tween(this.root.position).to({y:targetY},1500).easing(TWEEN.Easing.Linear.None).onStart(this.playSfx).delay(delay).start();return tw},game_shell.game.StarStrip.prototype.chooseColour=function(strip,colours){var index=Math.floor(Math.random()*colours.length),colour=colours[index];return strip.tint=colour,colour},game_shell.game.StarStrip.prototype.createStrip=function(root,stageH){var strip=new PIXI.Sprite(PIXI.utils.TextureCache["star_strip.png"]);return strip.anchor.set(.5,1),strip.width=this.size,strip.height=1.2*stageH,root.addChild(strip),strip},game_shell.game.StarStrip.prototype.createStar=function(root){var star=new PIXI.Sprite(PIXI.utils.TextureCache["star.png"]);return star.anchor.set(.5),star.width=this.size,star.scale.y=star.scale.x,star.y=6,root.addChild(star),star},game_shell.game.LayoutMaker=function(){},game_shell.game.LayoutMaker.prototype.getLayout=function(){var R=game_shell.game.Rotation;return[{length:2,rotation:R.HORIZONTAL,row:0,col:0},{length:3,rotation:R.VERTICAL,row:1,col:0},{length:2,rotation:R.VERTICAL,row:4,col:0},{length:2,rotation:R.HORIZONTAL,key:!0,row:2,col:1},{length:3,rotation:R.VERTICAL,row:1,col:3},{length:3,rotation:R.VERTICAL,row:0,col:5},{length:2,rotation:R.HORIZONTAL,row:4,col:4},{length:3,rotation:R.HORIZONTAL,row:5,col:2}]},game_shell.game.GameScene=function(){this.resolution=1,this.root=null,this.timeout=null,this.updateList=null,this.screenW=0,this.screenH=0},game_shell.game.GameScene.prototype=Object.create(core.utils.EventDispatcher.prototype),game_shell.game.GameScene.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.userRecord.reset(),this.bindMethods(),this.builder=this.build();var blocks=this.model.createBlocks(this.map.blocks);this.blocks=this.builder.createBlockViews(blocks,this),this.addListeners(),this.snd.playWithDelay("fall_in",50)},game_shell.game.GameScene.prototype.addListeners=function(){this.bus.on("moved",this.blockMoved),this.resetBtn.on("release",this.reset),this.homeBtn.on("release",this.home),this.muteBtn.on("toggle",this.mute)},game_shell.game.GameScene.prototype.bindMethods=function(){this.blockMoved=this._blockMoved.bind(this),this.reset=this._reset.bind(this),this.home=this._home.bind(this),this.mute=this._mute.bind(this)},game_shell.game.GameScene.prototype._mute=function(){this.snd.mute(!this.snd.isMuted)},game_shell.game.GameScene.prototype._reset=function(){this.userRecord.reset(),this.enableBlocks(!1),this.exitTransition.activate(),this.eventQueue.emit({type:"game_event",msg:"restart_level"})},game_shell.game.GameScene.prototype._home=function(){this.bus.emit({type:"home"}),this.eventQueue.emit({type:"game_event",msg:"exit_to_menu"})},game_shell.game.GameScene.prototype._blockMoved=function(event){var moves=this.userRecord.move();this.counterField.text=moves.toString(),this.snd.play("drop_block"),event.win&&this.levelComplete()},game_shell.game.GameScene.prototype.gameComplete=function(){this.endTransition.activate(),this.resetBtn.enabled=!1,this.homeBtn.enabled=!1,this.muteBtn.enabled=!1},game_shell.game.GameScene.prototype.levelComplete=function(){this.enableBlocks(!1),console.log("GameScene levelComplete"),this.userRecord.complete(),this.user.levelComplete(this.userRecord),this.exitTransition.activate()},game_shell.game.GameScene.prototype.enableBlocks=function(bool){var i,block,n=this.blocks.length;for(i=0;i<n;i++)block=this.blocks[i],block.enable(bool)},game_shell.game.GameScene.prototype.build=function(){var builder=new game_shell.game.GameBuilder;return builder.init({scene:this,screenW:this.screenW,screenH:this.screenH,resolution:this.resolution}),builder},game_shell.game.GameModel=function(){this.tileSize=80,this.grid=null,this.blocks=null,this.debug=!1},game_shell.game.GameModel.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.grid=this.createGrid(config),this.blocks=[]},game_shell.game.GameModel.prototype.createBlocks=function(layout){var i,blockData,n=layout.length;for(i=0;i<n;i++)blockData=layout[i],this.addBlock(blockData);return this.debug&&this.log(),this.blocks},game_shell.game.GameModel.prototype.addBlock=function(blockData){var index=this.blocks.length,block=this.createBlock(blockData.length,blockData.rotation,blockData.key,index+1);return this.grid.setBlock(block,blockData.row,blockData.col),this.blocks[index]=block,block},game_shell.game.GameModel.prototype.createBlock=function(length,rotation,isKey,index){var block=new game_shell.game.GameBlock;return block.init({length:length,isKey:isKey||!1,cols:this.grid.cols,tileSize:this.tileSize,rotation:rotation,id:index}),block},game_shell.game.GameModel.prototype.log=function(){console.log(this.grid.log())},game_shell.game.GameModel.prototype.createGrid=function(config){var grid=new game_shell.game.GameGrid;return grid.init({rows:config.rows,cols:config.cols,tileSize:config.tileSize}),grid},Object.defineProperties(game_shell.game.GameModel.prototype,{tiles:{get:function(){return this.grid.tiles}}}),game_shell.game.GameGrid=function(){this.tiles=null,this.tileSize=80,this.rows=6,this.cols=6,this._tileCache=[]},game_shell.game.GameGrid.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.tiles=this.createTiles(config)},game_shell.game.GameGrid.prototype.setBlock=function(block,row,col){return block.tiles=this.getTilesForBlock(block,row,col),block},game_shell.game.GameGrid.prototype.getTilesForBlock=function(block,row,col){var tiles=this._tileCache;if(tiles.length=0,tiles[0]=this.getTile(row,col),block.isHorizontal)for(var lastCol=col+block.length-1;col<lastCol;)col++,tiles[tiles.length]=this.getTile(row,col);else for(var lastRow=row+block.length-1;row<lastRow;)row++,tiles[tiles.length]=this.getTile(row,col);return tiles},game_shell.game.GameGrid.prototype.getTile=function(row,col){var index=row*this.rows+col;return this.tiles[index]},game_shell.game.GameGrid.prototype.log=function(){var i,modder,tile,log="",cols=this.cols,n=this.tiles.length;for(i=0;i<n;i++)tile=this.tiles[i],log+=tile.log+" ",modder=i+1,modder>1&&modder%cols===0&&(log+="\n");return log},game_shell.game.GameGrid.prototype.createTiles=function(config){var tile,i,row,col,tiles=[],rows=config.rows,cols=config.cols,tileSize=config.tileSize,total=rows*cols;for(i=0;i<total;i++)col=i%cols,row=Math.floor(i/rows),tile=new game_shell.game.GameTile,tile.init({tileSize:tileSize,row:row,col:col}),tiles[i]=tile;return tiles},game_shell.game.GameTile=function(){this.row=0,this.col=0,this.tileSize=80,this.block=null,this.x=0,this.y=0},game_shell.game.GameTile.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.x=this.col*this.tileSize,this.y=this.row*this.tileSize},Object.defineProperties(game_shell.game.GameTile.prototype,{log:{get:function(){return this.block?this.block.log:"0"}}}),game_shell.game.GameBlock=function(){this.length=0,this.rotation=0,this.isKey=!1,this.id=0,this._tiles=[]},game_shell.game.GameBlock.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s])},game_shell.game.GameBlock.prototype.clearTiles=function(){var n=this._tiles.length;if(n>0){var i,tile;for(i=0;i<n;i++)tile=this._tiles[i],tile.block=null}this._tiles.length=0},Object.defineProperties(game_shell.game.GameBlock.prototype,{tiles:{set:function(tiles){this.clearTiles();var i,tile,n=tiles.length;for(i=0;i<n;i++)tile=tiles[i],tile.block=this,this._tiles[i]=tile},get:function(){return this._tiles}},isHorizontal:{get:function(){return this.rotation===game_shell.game.Rotation.HORIZONTAL}},isVertical:{get:function(){return this.rotation===game_shell.game.Rotation.VERTICAL}},height:{get:function(){var n=this.isVertical?this.length:1;return this.tileSize*n}},width:{get:function(){var n=this.isHorizontal?this.length:1;return this.tileSize*n}},log:{get:function(){return this.id.toString()}}}),game_shell.game.GameSound=function(){this.snd=null,this.dragSfx="move_block"},game_shell.game.GameSound.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s])},game_shell.game.GameSound.prototype.drag=function(){this.snd.isPlaying(this.dragSfx)||this.snd.play(this.dragSfx)},game_shell.game.GridView=function(){this.root=null,this.model=null,this.alpha=.15},game_shell.game.GridView.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.root=this.createRoot(this.model);this.createGraphics(this.model,this.root,this.alpha)},game_shell.game.GridView.prototype.fadeOut=function(){var self=this;new TWEEN.Tween(this.root).to({alpha:0},1e3).onComplete(function(){self.bus.emit({type:"next_level"})}).start()},game_shell.game.GridView.prototype.createGraphics=function(model,root,alpha){var i,tile,graphics=new PIXI.Graphics,tiles=model.tiles,tileSize=model.tileSize,n=tiles.length;for(i=0;i<n;i++){tile=tiles[i];var target=tile.row%2===0?1:0,colour=i%2===target?0:16777215;graphics.beginFill(colour,alpha),graphics.drawRect(tile.x,tile.y,tileSize,tileSize),graphics.endFill()}return graphics},game_shell.game.GridView.prototype.createRoot=function(model){var tileSize=model.tileSize,root=new PIXI.Container;return root.x=tileSize*(model.cols*-.5),root.y=tileSize*(model.rows*-.5),root},game_shell.game.BlockView=function(){this.blockModel=null,this.sprite=null,this.bus=null,this.dragging=!1,this.min=0,this.max=480,this.oldPosition=new PIXI.Point,this.gameSound=null,this.pt=new PIXI.Point,this.dragOffset=new PIXI.Point,this.eventStartDrag={type:"start_drag",block:this},this.eventStopDrag={type:"stop_drag",block:this},this.eventMoved={type:"moved",block:this,isKey:!1,win:!1}},game_shell.game.BlockView.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.sprite=this.createSprite(this.blockModel),this.eventMoved.isKey=this.isKey,this.updatePosition(),this.bindMethods(),this.addListeners(),this.enable(!0)},game_shell.game.BlockView.prototype.enable=function(bool){this.sprite.interactive=bool,this.sprite.buttonMode=bool},game_shell.game.BlockView.prototype.bindMethods=function(){this.touchstart=this._touchstart.bind(this),this.touchmove=this._touchmove.bind(this),this.touchend=this._touchend.bind(this)},game_shell.game.BlockView.prototype.snapRow=function(row,tileSize){this.sprite.y=row*tileSize,row!==this.oldPosition.y&&this.bus.emit(this.eventMoved)},game_shell.game.BlockView.prototype.snapCol=function(col,tileSize){this.sprite.x=col*tileSize,col!==this.oldPosition.x&&(this.isKey&&(this.eventMoved.win=col>=this.blockModel.cols-1),this.bus.emit(this.eventMoved))},game_shell.game.BlockView.prototype.addListeners=function(){this.sprite.on("mousedown",this.touchstart),this.sprite.on("touchstart",this.touchstart),this.sprite.on("mousemove",this.touchmove),this.sprite.on("touchmove",this.touchmove),this.sprite.on("mouseup",this.touchend),this.sprite.on("touchend",this.touchend),this.sprite.on("mouseupoutside",this.touchend),this.sprite.on("touchendoutside",this.touchend)},game_shell.game.BlockView.prototype.transitionIn=function(){var target={x:this.sprite.x,y:this.sprite.y};this.sprite.y-=500,new TWEEN.Tween(this.sprite.position).to(target,600).easing(TWEEN.Easing.Sinusoidal.Out).start()},game_shell.game.BlockView.prototype.transitionOut=function(){var target;target=this.isKey?{x:660}:{y:this.sprite.y+500},new TWEEN.Tween(this.sprite.position).to(target,600).easing(TWEEN.Easing.Sinusoidal.Out).start()},Object.defineProperties(game_shell.game.BlockView.prototype,{isVertical:{get:function(){return this.blockModel.isVertical}},isHorizontal:{get:function(){return this.blockModel.isHorizontal}},isKey:{get:function(){return this.blockModel.isKey}},x:{get:function(){return this.sprite.x}},y:{get:function(){return this.sprite.y}}}),game_shell.game.BlockView.prototype._touchstart=function(event){this.storeStartLocation();var iData=event.data;iData.getLocalPosition(this.sprite,this.pt),this.dragOffset.copy(this.pt),this.dragging=!0,this.bus.emit(this.eventStartDrag)},game_shell.game.BlockView.prototype.storeStartLocation=function(){var tile=this.blockModel.tiles[0];this.oldPosition.x=tile.col,this.oldPosition.y=tile.row},game_shell.game.BlockView.prototype.setLimits=function(min,max){this.min=min,this.max=max},game_shell.game.BlockView.prototype._touchmove=function(event){if(this.dragging){var iData=event.data;iData.getLocalPosition(this.sprite.parent,this.pt),this.isVertical?this.sprite.y=this.limit(this.pt.y-this.dragOffset.y):this.sprite.x=this.limit(this.pt.x-this.dragOffset.x),this.gameSound.drag()}},game_shell.game.BlockView.prototype.limit=function(input){return input>this.max?input=this.max:input<this.min&&(input=this.min),input},game_shell.game.BlockView.prototype._touchend=function(event){this.dragging&&(this.dragOffset.set(0,0),this.dragging=!1,this.bus.emit(this.eventStopDrag))},game_shell.game.BlockView.prototype.updatePosition=function(){var tile=this.blockModel.tiles[0];this.sprite.x=tile.x,this.sprite.y=tile.y},game_shell.game.BlockView.prototype.getTexture=function(blockModel){var r=game_shell.game.Rotation,txId="";return blockModel.isKey?txId="key":txId+=blockModel.rotation===r.HORIZONTAL?"h"+blockModel.length.toString():"v"+blockModel.length.toString(),txId+=".png",PIXI.utils.TextureCache[txId]},game_shell.game.BlockView.prototype.createSprite=function(blockModel){var tx=this.getTexture(blockModel);return new PIXI.Sprite(tx)},game_shell.game.MoveCapper=function(){this.bus=null,this.grid=null},game_shell.game.MoveCapper.prototype.init=function(config){for(var s in config)config.hasOwnProperty(s)&&(this[s]=config[s]);this.bindMethods(),this.addListeners()},game_shell.game.MoveCapper.prototype._startDrag=function(event){var blockView=event.block,blockModel=blockView.blockModel,min=0,max=0;blockModel.isVertical?(min=this.minY(blockModel),max=this.maxY(blockModel)):(min=this.minX(blockModel),max=this.maxX(blockModel)),blockView.setLimits(min,max)},game_shell.game.MoveCapper.prototype.maxY=function(blockModel){var tile=blockModel.tiles[blockModel.length-1],startY=blockModel.tiles[0].y,lastRow=this.grid.rows-1,numSpaces=0;if(tile.row<lastRow)for(var check=!0,col=tile.col;check;){var oldRow=tile.row;if(oldRow===lastRow)check=!1;else{var newRow=oldRow+1,newTile=this.grid.getTile(newRow,col);newTile.block?check=!1:(tile=newTile,numSpaces++)}}return startY+numSpaces*this.grid.tileSize},game_shell.game.MoveCapper.prototype.maxX=function(blockModel){var tile=blockModel.tiles[blockModel.length-1],startX=blockModel.tiles[0].x,lastCol=this.grid.cols-1,numSpaces=0;if(tile.col<lastCol)for(var check=!0,row=tile.row;check;){var oldCol=tile.col;if(oldCol===lastCol)check=!1;else{var newCol=oldCol+1,newTile=this.grid.getTile(row,newCol);newTile.block?check=!1:(tile=newTile,numSpaces++)}}return blockModel.isKey&&tile.col===lastCol&&(numSpaces+=blockModel.length),startX+numSpaces*this.grid.tileSize},game_shell.game.MoveCapper.prototype.minY=function(blockModel){var tile=blockModel.tiles[0],firstRow=0;if(tile.row>firstRow)for(var check=!0,col=tile.col;check;){var oldRow=tile.row;if(oldRow===firstRow)check=!1;else{var newRow=oldRow-1,newTile=this.grid.getTile(newRow,col);newTile.block?check=!1:tile=newTile}}return tile.y},game_shell.game.MoveCapper.prototype.minX=function(blockModel){var tile=blockModel.tiles[0],firstCol=0;if(tile.col>firstCol)for(var check=!0,row=tile.row;check;){var oldCol=tile.col;if(oldCol===firstCol)check=!1;else{var newCol=oldCol-1,newTile=this.grid.getTile(row,newCol);newTile.block?check=!1:tile=newTile}}return tile.x},game_shell.game.MoveCapper.prototype._stopDrag=function(event){var blockView=event.block,blockModel=blockView.blockModel,tileSize=this.grid.tileSize,tile=blockModel.tiles[0],targetRow=tile.row,targetCol=tile.col;blockModel.isVertical?(targetRow=Math.round(blockView.y/tileSize),blockView.snapRow(targetRow,tileSize)):(targetCol=Math.round(blockView.x/tileSize),blockView.snapCol(targetCol,tileSize)),this.grid.setBlock(blockModel,targetRow,targetCol)},game_shell.game.MoveCapper.prototype.addListeners=function(){this.bus.on("start_drag",this.startDrag),this.bus.on("stop_drag",this.stopDrag)},game_shell.game.MoveCapper.prototype.bindMethods=function(){this.startDrag=this._startDrag.bind(this),this.stopDrag=this._stopDrag.bind(this)},game_shell.game.Particles=function(){core.game.ParticleBase.call(this)},game_shell.game.Particles.prototype=Object.create(core.game.ParticleBase.prototype),game_shell.game.Particles.prototype.createEmitter=function(){var emitter=new Proton.Emitter;this.life=3;var maxSpeed=3,minSpeed=.6*maxSpeed,numberPerEmission=30,timePerEmission=.1,maxScale=3,minScale=.5;return emitter.addInitialize(new Proton.ImageTarget(this.texture)),emitter.rate=new Proton.Rate(numberPerEmission,timePerEmission),emitter.addInitialize(new Proton.Mass(1)),emitter.addInitialize(new Proton.Life(this.life,this.life)),emitter.addInitialize(new Proton.V(new Proton.Span(minSpeed,maxSpeed),new Proton.Span(0,360),"polar")),emitter.addBehaviour(new Proton.Alpha(1,0)),emitter.addBehaviour(new Proton.Scale(Proton.getSpan(minScale,maxScale),0)),emitter.addBehaviour(new Proton.GravityWell({x:0,y:0},10)),emitter},game_shell.game.GameBuilder=function(){core.screens.SceneBuilder.call(this)},game_shell.game.GameBuilder.prototype.init=function(config){core.screens.SceneBuilder.prototype.init.call(this,config),this.scene.background=this.createBackground(this.scene),this.scene.model=this.createModel(this.scene),this.scene.moveCapper=this.createMoveCapper(this.scene),this.scene.gridView=this.createGridView(this.scene),this.scene.particles=this.createParticles(this.scene),this.scene.foreground=this.createForeground(this.scene),this.scene.counterField=this.createCounterField(this.scene),this.scene.resetBtn=this.createResetButton(this.scene),this.scene.homeBtn=this.createHomeButton(this.scene),this.scene.muteBtn=this.createMuteButton(this.scene),this.scene.exitTransition=this.createExitTransition(this.scene),this.scene.endTransition=this.createEndTransition(this.scene),this.scene.gameSound=this.createGameSound(this.scene)},game_shell.game.GameBuilder.prototype.createParticles=function(scene){var particles=new game_shell.game.Particles,particleRoot=new PIXI.Container;return scene.root.addChild(particleRoot),particles.init({texture:PIXI.utils.TextureCache["fire.png"],root:particleRoot,resolution:scene.resolution}),scene.updateList.add(particles),particles},game_shell.game.GameBuilder.prototype.createGameSound=function(scene){var gameSound=new game_shell.game.GameSound;return gameSound.init({snd:scene.snd}),gameSound},game_shell.game.GameBuilder.prototype.createExitTransition=function(scene){var exitTransition=new game_shell.game.ExitTransition;return exitTransition.init({bus:scene.bus,snd:scene.snd,particles:scene.particles,timeout:scene.timeout}),exitTransition},game_shell.game.GameBuilder.prototype.createEndTransition=function(scene){var endTransition=new game_shell.game.EndTransition;return endTransition.init({screenW:scene.screenW,screenH:scene.screenH,snd:scene.snd,bus:scene.bus,timeout:scene.timeout}),scene.root.addChild(endTransition.root),endTransition},game_shell.game.GameBuilder.prototype.createMuteButton=function(scene){var btn=new core.display.Toggle("mute_button_off.png","mute_button_on.png");return btn.x=81,btn.y=-178,scene.snd.isMuted&&btn.setOff(),scene.root.addChild(btn),btn},game_shell.game.GameBuilder.prototype.createHomeButton=function(scene){var btn=new core.display.Button("home_button.png");return btn.x=-81,btn.y=-178,scene.root.addChild(btn),btn},game_shell.game.GameBuilder.prototype.createResetButton=function(scene){var btn=new core.display.Button("reset_button.png");return btn.x=81,btn.y=185,scene.root.addChild(btn),btn},game_shell.game.GameBuilder.prototype.createCounterField=function(scene){var field=new PIXI.extras.BitmapText("0",{font:{name:"wolves",size:42}});return field.x=-15,field.y=164,scene.root.addChild(field),field},game_shell.game.GameBuilder.prototype.createMoveCapper=function(scene){var moveCapper=new game_shell.game.MoveCapper;return moveCapper.init({bus:scene.bus,grid:scene.model.grid}),moveCapper},game_shell.game.GameBuilder.prototype.createBlockViews=function(blockModels,scene){var i,blockModel,blockView,blockViews=[],root=scene.gridView.root,n=blockModels.length;for(i=0;i<n;i++)blockModel=blockModels[i],blockView=this.createBlockView(blockModel,root,scene),blockView.transitionIn(),blockViews[i]=blockView;return scene.exitTransition.blocks=blockViews,blockViews},game_shell.game.GameBuilder.prototype.createBlockView=function(blockModel,root,scene){var blockView=new game_shell.game.BlockView;return blockView.init({blockModel:blockModel,gameSound:scene.gameSound,bus:scene.bus}),root.addChild(blockView.sprite),blockView},game_shell.game.GameBuilder.prototype.createGridView=function(scene){var gridView=new game_shell.game.GridView;return gridView.init({model:scene.model,bus:scene.bus}),scene.root.addChild(gridView.root),gridView},game_shell.game.GameBuilder.prototype.createModel=function(scene){var model=new game_shell.game.GameModel;return model.init({tileSize:40,rows:6,cols:6,bus:scene.bus,debug:!0}),model},game_shell.game.GameBuilder.prototype.createBackground=function(scene){var bg=new PIXI.Sprite(PIXI.utils.TextureCache["grid_background.png"]);return bg.anchor.set(.5),scene.root.addChild(bg),bg},game_shell.game.GameBuilder.prototype.createForeground=function(scene){var bg=new PIXI.Sprite(PIXI.utils.TextureCache["game_background.png"]);return bg.anchor.set(.5),scene.root.addChild(bg),bg},game_shell.game.GameBuilder.prototype.createFill=function(scene){var q=new core.display.Quad(scene.screenW,scene.screenH,10066329);return q.pivot.x=.5*q.width,q.pivot.y=.5*q.height,scene.root.addChild(q),q};